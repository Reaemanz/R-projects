---
title: "New_Boxplots"
author: "EmmaReagan"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R BOXPLOTS

```{r}
install.packages("readr")
```


```{r message=FALSE, warning=FALSE}

library(readr)
library(tidyverse)
library(glue)
library(dplyr)
library(tidyr)

```


Load dataset

```{r}
# Load the final dataset
final_file <- "F:/Reaemanz/Raising the village/AHS Boxplots/final_dataset.csv"
final_dataset <- read_csv(final_file)

# Check dimensions and preview
dim(final_dataset)      # shows rows and columns

```

```{r}
View(final_dataset) # preview first 10 rows

```


```{r}
# Convert all columns except the 4 character ones to integer
final_dataset <- final_dataset %>%
  mutate(across(
    .cols = -c(pre_hhid, treat_status, pre_village, pre_district),
    .fns = as.integer
  ))

glimpse(final_dataset)
```

BOXPLOT FUNCTION (LOOP)

```{r}
boxplot_function <- function(df, var) {
  for (i in var) {

    # Define paths for PNG and SVG
    path_png <- glue("image/{i}.png")
    path_svg <- glue("image/{i}.svg")
    
    # Remove outliers
    data_no_outliers <- df %>%
      mutate(treat_status = if_else(treat_status == "Control", "PEER", "RTV")) %>%
      filter(
        !is.na(.data[[i]]),
        between(
          .data[[i]],
          quantile(.data[[i]], 0.25, na.rm = TRUE) - 1.5 * IQR(.data[[i]], na.rm = TRUE),
          quantile(.data[[i]], 0.75, na.rm = TRUE) + 1.5 * IQR(.data[[i]], na.rm = TRUE)
        )
      )
    
    # Calculate medians for labeling and line
    medians <- data_no_outliers %>%
      group_by(treat_status) %>%
      summarise(med = median(.data[[i]], na.rm = TRUE), .groups = "drop")
    
    # Define fill and border colors
    fill_colors <- c("RTV" = "#008793", "PEER" = "#8B9798")
    
    # Create boxplot
    plot <- ggplot(data_no_outliers, aes(x = treat_status, y = .data[[i]], fill = treat_status, color = treat_status)) +
      # Boxplot with matching fill and border color
      geom_boxplot(width = 0.6, outlier.shape = NA, size = 1.2) +
      # Thin whisker caps matching fill color
      stat_boxplot(geom = "errorbar", width = 0.3, size = 0.6) +
      # White median line using geom_segment
      geom_segment(data = medians,
                   aes(x = as.numeric(factor(treat_status)) - 0.3,
                       xend = as.numeric(factor(treat_status)) + 0.3,
                       y = med, yend = med),
                   color = "white", size = 1.2, inherit.aes = FALSE) +
      # Median value label in white, above the line
      geom_text(data = medians,
                aes(x = treat_status, y = med, label = round(med, 2)),
                vjust = -1.2, size = 4.5, color = "white", fontface = "bold", inherit.aes = FALSE) +
      scale_fill_manual(values = fill_colors) +
      scale_color_manual(values = fill_colors) +
      labs(title = glue("{i}: Yield Distribution - RTV vs. PEER (No Outliers)"),
           y = "Yield per Unit") +
      theme_minimal(base_size = 14) +
      theme(
        legend.position = "none",
        panel.grid.major.x = element_blank(),
        axis.title.x = element_blank(),
        axis.text.x = element_text(size = 12)
      )
    
    ggsave(filename = path, plot = plot, width = 6, height = 5)
  }
}

```


Generate Boxplots 1

```{r}
boxplot_function(data, var = vars)

```


Generate Boxplots 1
```{r}
boxplot_function(data,var = varss)

```

```{r}
var_pere <- data %>% 
  select(matches("^per_uni")) %>% names()

boxplot_function(data,var = var_pere)
```


```{r}

pere_price <- data %>% 
  select(matches("price_usd$|price_fresh_usd")& matches("food|hulled|cherry|alcohol|tea|jackfruit|avocado|ripe|kiboko|flower|process"),
         -other_average_price_usd) %>% names()

boxplot_function(data,var = pere_price)
```



BOX PLOT FUNCTION INDIVIDUAL VARIABLES

```{r}

boxplot_function <- function(df, var) {
  # Define paths for PNG and SVG
  path_png <- glue("image/{i}.png")
  path_svg <- glue("image/{i}.svg")
  
  # Remove outliers
  data_no_outliers <- df %>%
    mutate(treat_status = if_else(treat_status == "Control", "PEER", "RTV")) %>%
    filter(
      !is.na(.data[[var]]),
      between(
        .data[[var]],
        quantile(.data[[var]], 0.25, na.rm = TRUE) - 1.5 * IQR(.data[[var]], na.rm = TRUE),
        quantile(.data[[var]], 0.75, na.rm = TRUE) + 1.5 * IQR(.data[[var]], na.rm = TRUE)
      )
    )
  
  # Calculate medians for labeling and line
  medians <- data_no_outliers %>%
    group_by(treat_status) %>%
    summarise(med = median(.data[[var]], na.rm = TRUE), .groups = "drop")
  
  # Define fill and border colors
  fill_colors <- c("RTV" = "#008793", "PEER" = "#8B9798")
  
  # Create boxplot
  plot <- ggplot(data_no_outliers, aes(x = treat_status, y = .data[[var]], fill = treat_status, color = treat_status)) +
    geom_boxplot(width = 0.6, outlier.shape = NA, size = 1.2) +
    stat_boxplot(geom = "errorbar", width = 0.3, size = 0.6) +
    geom_segment(data = medians,
                 aes(x = as.numeric(factor(treat_status)) - 0.3,
                     xend = as.numeric(factor(treat_status)) + 0.3,
                     y = med, yend = med),
                 color = "white", size = 1.2, inherit.aes = FALSE) +
    geom_text(data = medians,
              aes(x = treat_status, y = med, label = round(med, 2)),
              vjust = -1.2, size = 4.5, color = "white", fontface = "bold", inherit.aes = FALSE) +
    scale_fill_manual(values = fill_colors) +
    scale_color_manual(values = fill_colors) +
    labs(
      title = glue("{var}: Yield Distribution - RTV vs. PEER (No Outliers)"),
      x = NULL,
      y = NULL
    ) +
    theme_minimal(base_size = 14) +
    theme(
      legend.position = "none",
      panel.grid.major.x = element_blank(),
      axis.text.x = element_text(size = 12),
      plot.title = element_text(hjust = 1) # align title to right
    )
  
  ggsave(filename = path, plot = plot, width = 6, height = 5)
}

```


CASSAVA TOTAL YIELD

```{r}
boxplot_function(final_dataset, "total_cassava_yield")

```


CUSTOM TITLE INPUT FUNCTION

```{r}

boxplot_function <- function(df, var, plot_title = NULL) {
  # Ensure glue is loaded
  if(!require(glue)) install.packages("glue"); library(glue)
  
  # Define paths for PNG and SVG
  path_png <- glue("image/{i}.png")
  path_svg <- glue("image/{i}.svg")
  
  # Remove outliers
  data_no_outliers <- df %>%
    mutate(treat_status = if_else(treat_status == "Control", "Peers", "RTV"),
           # Set factor levels to ensure RTV comes first
           treat_status = factor(treat_status, levels = c("RTV", "Peers"))) %>%
    filter(
      !is.na(.data[[var]]),
      between(
        .data[[var]],
        quantile(.data[[var]], 0.25, na.rm = TRUE) - 1.5 * IQR(.data[[var]], na.rm = TRUE),
        quantile(.data[[var]], 0.75, na.rm = TRUE) + 1.5 * IQR(.data[[var]], na.rm = TRUE)
      )
    )
  
  # Calculate medians for labeling and line
  medians <- data_no_outliers %>%
    group_by(treat_status) %>%
    summarise(med = median(.data[[var]], na.rm = TRUE), .groups = "drop")
  
  # Define fill and border colors
  fill_colors <- c("RTV" = "#008793", "Peers" = "#8B9798")
  
  # Use provided title or default
  final_title <- ifelse(is.null(plot_title),
                        glue("{var}: Yield Distribution - RTV vs. PEER (No Outliers)"),
                        plot_title)
  
  # Create boxplot
  plot <- ggplot(data_no_outliers, aes(x = treat_status, y = .data[[var]], fill = treat_status, color = treat_status)) +
    geom_boxplot(width = 0.6, outlier.shape = NA, size = 1.2) +
    stat_boxplot(geom = "errorbar", width = 0.3, size = 0.6) +
    geom_segment(data = medians,
                 aes(x = as.numeric(factor(treat_status)) - 0.3,
                     xend = as.numeric(factor(treat_status)) + 0.3,
                     y = med, yend = med),
                 color = "white", size = 1.2, inherit.aes = FALSE) +
    geom_text(data = medians,
              aes(x = treat_status, y = med, label = round(med, 2)),
              vjust = -0.8, size = 4.0, color = "black", fontface = "bold", inherit.aes = FALSE) +
    scale_fill_manual(values = fill_colors) +
    scale_color_manual(values = fill_colors) +
    labs(
      title = final_title,
      x = NULL,
      y = NULL
    ) +
    theme_minimal(base_size = 14) +
    theme(
      legend.position = "none",
      panel.grid.major.x = element_blank(),
      axis.text.x = element_text(size = 12),
      plot.title = element_text(hjust = 0) # align title to left
    )
  
  # Save the plot
  ggsave(filename = path, plot = plot, width = 6, height = 5)
}

```

## FINAL BOXPLOT FUNCTION

```{r}
boxplot_function <- function(df, var, plot_title = NULL) {
  # Ensure glue is loaded
  if(!require(glue)) install.packages("glue"); library(glue)
  
  # Define paths for PNG and SVG
  path_png <- glue("image/{var}.png")
  path_svg <- glue("image/{var}.svg")
  
  # Remove outliers
  data_no_outliers <- df %>%
    mutate(treat_status = if_else(treat_status == "Control", "Peers", "RTV"),
           treat_status = factor(treat_status, levels = c("RTV", "Peers"))) %>%
    filter(
      !is.na(.data[[var]]),
      between(
        .data[[var]],
        quantile(.data[[var]], 0.25, na.rm = TRUE) - 1.5 * IQR(.data[[var]], na.rm = TRUE),
        quantile(.data[[var]], 0.75, na.rm = TRUE) + 1.5 * IQR(.data[[var]], na.rm = TRUE)
      )
    )
  
  # Calculate medians
  medians <- data_no_outliers %>%
    group_by(treat_status) %>%
    summarise(med = median(.data[[var]], na.rm = TRUE), .groups = "drop")
  
  # Define fill colors
  fill_colors <- c("RTV" = "#008793", "Peers" = "#8B9798")
  
  # Title
  final_title <- ifelse(is.null(plot_title),
                        glue("{var}: Yield Distribution - RTV vs. PEER (No Outliers)"),
                        plot_title)
  
  # Create boxplot
  plot <- ggplot(data_no_outliers, aes(x = treat_status, y = .data[[var]], fill = treat_status, color = treat_status)) +
    geom_boxplot(width = 0.6, outlier.shape = NA, size = 1.2) +
    stat_boxplot(geom = "errorbar", width = 0.3, size = 0.6) +
    geom_segment(data = medians,
                 aes(x = as.numeric(factor(treat_status)) - 0.3,
                     xend = as.numeric(factor(treat_status)) + 0.3,
                     y = med, yend = med),
                 color = "white", size = 1.2, inherit.aes = FALSE) +
    geom_text(data = medians,
              aes(x = treat_status, y = med, label = round(med, 2)),
              vjust = -0.5, size = 4.0, color = "black", fontface = "bold", inherit.aes = FALSE) +
    scale_fill_manual(values = fill_colors) +
    scale_color_manual(values = fill_colors) +
    labs(
      title = final_title,
      x = NULL,
      y = NULL
    ) +
    theme_minimal(base_size = 14) +
    theme(
      legend.position = "none",
      panel.grid.major.x = element_blank(),
      axis.text.x = element_text(size = 12),
      plot.title = element_text(hjust = 0)
    )
  
  # Save both PNG and SVG
  ggsave(filename = path_png, plot = plot, width = 6, height = 5, dpi = 300)
  ggsave(filename = path_svg, plot = plot, width = 6, height = 5)
}


```


## SAVE BOXPLOTS

```{r}

boxplot_function(final_dataset, "total_cassava_yield", plot_title = "CASSAVA (BAG)")
boxplot_function(final_dataset, "beans_per_unit", plot_title = "BEANS (KG)")
boxplot_function(final_dataset, "gnuts_per_unit", plot_title = "GROUNDNUTS (KG)")
boxplot_function(final_dataset, "irish_potatoes_per_unit", plot_title = "IRISHPOTATOES (BAG)")
boxplot_function(final_dataset, "maize_per_unit", plot_title = "MAIZE (KG)")
boxplot_function(final_dataset, "millet_per_unit", plot_title = "MILLET (KG)")
boxplot_function(final_dataset, "total_sweetpotatoes_yield", plot_title = "SWEETPOTATOES (BAG)")
boxplot_function(final_dataset, "sorghum_per_unit", plot_title = "SORGHUM (KG)")
boxplot_function(final_dataset, "soya_beans_per_unit", plot_title = "SOYA BEANS (KG)")
boxplot_function(final_dataset, "average_beans_market_price_usd", plot_title = "BEANS")
boxplot_function(final_dataset, "average_soya_beans_market_price_usd", plot_title = "SOYA BEANS")
boxplot_function(final_dataset, "average_cassava_market_price_usd", plot_title = "CASSAVA")
boxplot_function(final_dataset, "average_sweetpotatoes_market_price_usd", plot_title = "SWEET POTATOES")
boxplot_function(final_dataset, "average_irish_potatoes_market_price_usd", plot_title = "IRISH POTATOES")
boxplot_function(final_dataset, "average_gnuts_market_price_usd", plot_title = "GROUND NUTS MARKET")
boxplot_function(final_dataset, "average_millet_market_price_usd", plot_title = "MILLET")
boxplot_function(final_dataset, "average_maize_market_price_usd", plot_title = "MAIZE MARKET")
boxplot_function(final_dataset, "average_sorghum_market_price_usd", plot_title = "SORGHUM")
boxplot_function(final_dataset, "per_unit_food_banana", plot_title = "FOOD BANANA (BUNCH)")
boxplot_function(final_dataset, "per_unit_ripe_banana", plot_title = "RIPE BANANA (BUNCH)")
boxplot_function(final_dataset, "per_unit_alcohol_banana", plot_title = "ALCOHOL BANANA (BUNCH)")
boxplot_function(final_dataset, "per_unit_coffee", plot_title = "COFFEE (KG)")
boxplot_function(final_dataset, "hulled_average_price_usd", plot_title = "HULLED COFFEE")
boxplot_function(final_dataset, "flower_average_price_usd", plot_title = "FLOWER COFFEE")
boxplot_function(final_dataset, "process_average_price_usd", plot_title = "PROCESS COFFEE")
boxplot_function(final_dataset, "cherry_average_price_usd", plot_title = "CHERRY COFFEE")
boxplot_function(final_dataset, "kiboko_average_price_usd", plot_title = "KIBOKO AVERAGE PRICE (USD)")
# boxplot_function(final_dataset, "avg_hulled_robusta_price_usd", plot_title = "HULLED ROBUSTA")
# boxplot_function(final_dataset, "avg_hulled_arabica_price_usd", plot_title = "HULLED ARABICA PRICE (USD)")
# boxplot_function(final_dataset, "avg_flower_robusta_price_usd", plot_title = "FLOWER ROBUSTA PRICE (USD)")
# boxplot_function(final_dataset, "avg_flower_arabica_price_usd", plot_title = "FLOWER ARABICA PRICE (USD)")
# boxplot_function(final_dataset, "avg_process_robusta_price_usd", plot_title = "PROCESS ROBUSTA PRICE (USD)")
# boxplot_function(final_dataset, "avg_process_arabica_price_usd", plot_title = "PROCESS ARABICA PRICE (USD)")
# boxplot_function(final_dataset, "avg_cherry_robusta_price_usd", plot_title = "CHERRY ROBUSTA PRICE (USD)")
# boxplot_function(final_dataset, "avg_cherry_arabica_price_usd", plot_title = "CHERRY ARABICA PRICE (USD)")
# boxplot_function(final_dataset, "avg_kiboko_robusta_price_usd", plot_title = "KIBOKO ROBUSTA PRICE (USD)")
# boxplot_function(final_dataset, "avg_kiboko_arabica_price_usd", plot_title = "KIBOKO ARABICA PRICE (USD)")
boxplot_function(final_dataset, "food_banana_price_usd", plot_title = "FOOD BANANA")
boxplot_function(final_dataset, "alcohol_banana_price_usd", plot_title = "ALCOHOL BANANA")
boxplot_function(final_dataset, "ripe_banana_price_usd", plot_title = "RIPE BANANA")
# boxplot_function(final_dataset, "tea_price_usd", plot_title = "TEA PRICE (USD)")
# boxplot_function(final_dataset, "jackfruit_price_fresh_usd", plot_title = "JACKFRUIT PRICE FRESH (USD)")
# boxplot_function(final_dataset, "avocado_price_fresh_usd", plot_title = "AVOCADO PRICE FRESH (USD)")
boxplot_function(final_dataset, "total_robusta_yield", plot_title = "ROBUSTA (KG)")
boxplot_function(final_dataset, "total_arabica_yield", plot_title = "ARABICA (KG)")


boxplot_function(final_dataset, "per_unit_tea", plot_title = "TEA (KG)")
boxplot_function(final_dataset, "per_unit_jackfruit", plot_title = "JACKFRUIT (EACH)")
boxplot_function(final_dataset, "per_unit_avocado", plot_title = "AVOCADO (EACH)")

```


TABLE OF STATS

```{r}

# List of variables to summarize
vars_to_summarise <- c(
  "total_cassava_yield", "beans_per_unit", "gnuts_per_unit", "irish_potatoes_per_unit",
  "maize_per_unit", "millet_per_unit", "total_sweetpotatoes_yield", "sorghum_per_unit",
  "soya_beans_per_unit", "average_beans_market_price_usd", "average_soya_beans_market_price_usd",
  "average_cassava_market_price_usd", "average_sweetpotatoes_market_price_usd",
  "average_irish_potatoes_market_price_usd", "average_gnuts_market_price_usd",
  "average_millet_market_price_usd", "average_maize_market_price_usd", "average_sorghum_market_price_usd",
  "per_unit_food_banana", "per_unit_ripe_banana", "per_unit_alcohol_banana",
  "per_unit_tea", "per_unit_jackfruit", "per_unit_avocado", "per_unit_coffee",
  "hulled_average_price_usd", "flower_average_price_usd", "process_average_price_usd",
  "cherry_average_price_usd", "kiboko_average_price_usd",
  "avg_hulled_robusta_price_usd", "avg_hulled_arabica_price_usd",
  "avg_flower_robusta_price_usd", "avg_flower_arabica_price_usd",
  "avg_process_robusta_price_usd", "avg_process_arabica_price_usd",
  "avg_cherry_robusta_price_usd", "avg_cherry_arabica_price_usd",
  "avg_kiboko_robusta_price_usd", "avg_kiboko_arabica_price_usd",
  "food_banana_price_usd", "alcohol_banana_price_usd", "ripe_banana_price_usd",
  "tea_price_usd", "jackfruit_price_fresh_usd", "avocado_price_fresh_usd"
)

# Function to calculate boxplot stats
boxplot_stats <- function(x) {
  stats <- boxplot.stats(x)$stats  # [lower whisker, Q1, median, Q3, upper whisker]
  names(stats) <- c("lower_whisker","Q1","median","Q3","upper_whisker")
  return(as.list(stats))
}

# Outlier removal function
remove_outliers <- function(x) {
  Q1 <- quantile(x, 0.25, na.rm = TRUE)
  Q3 <- quantile(x, 0.75, na.rm = TRUE)
  IQR_val <- IQR(x, na.rm = TRUE)
  x[x >= (Q1 - 1.5*IQR_val) & x <= (Q3 + 1.5*IQR_val)]
}

# Create summary table for all variables
summary_table_all <- final_dataset %>%
  mutate(treat_status = if_else(treat_status == "Control", "Peers", "RTV"),
         treat_status = factor(treat_status, levels = c("RTV", "Peers"))) %>%
  select(treat_status, all_of(vars_to_summarise)) %>%
  pivot_longer(cols = -treat_status, names_to = "variable", values_to = "value") %>%
  group_by(variable, treat_status) %>%
  summarise(
    value_no_outliers = list(remove_outliers(value)),
    .groups = "drop"
  ) %>%
  rowwise() %>%
  mutate(stats = list(boxplot_stats(unlist(value_no_outliers)))) %>%
  unnest_wider(stats) %>%
  pivot_wider(
    names_from = treat_status,
    values_from = c(Q1, median, Q3, lower_whisker, upper_whisker),
    names_glue = "{treat_status}_{.value}"
  ) %>%
  arrange(variable) %>%
  mutate(across(where(is.numeric), ~round(., 3)))

# View
View(summary_table_all)

```


























BOXPLOT FUNCTION WITH OUTLIER OPTION

```{r}
boxplot_function_2 <- function(df, var, plot_title = NULL, remove_outliers = TRUE) {
  # Ensure glue is loaded
  if(!require(glue)) install.packages("glue"); library(glue)
  
  # Output path
  path <- glue("image/{var}.png")
  
  # Prepare base dataset with consistent treat_status factor
  data_prepared <- df %>%
    mutate(treat_status = if_else(treat_status == "Control", "Peers", "RTV"),
           treat_status = factor(treat_status, levels = c("RTV", "Peers"))) %>%
    filter(!is.na(.data[[var]]))
  
  # Optionally remove outliers
  if (remove_outliers) {
    data_prepared <- data_prepared %>%
      filter(
        between(
          .data[[var]],
          quantile(.data[[var]], 0.25, na.rm = TRUE) - 1.5 * IQR(.data[[var]], na.rm = TRUE),
          quantile(.data[[var]], 0.75, na.rm = TRUE) + 1.5 * IQR(.data[[var]], na.rm = TRUE)
        )
      )
  }
  
  # Calculate medians
  medians <- data_prepared %>%
    group_by(treat_status) %>%
    summarise(med = median(.data[[var]], na.rm = TRUE), .groups = "drop")
  
  # Fill colors
  fill_colors <- c("RTV" = "#008793", "Peers" = "#8B9798")
  
  # Title
  final_title <- ifelse(
    is.null(plot_title),
    glue("{var}: Yield Distribution - RTV vs. PEER {ifelse(remove_outliers, '(No Outliers)', '(With Outliers)')}"),
    plot_title
  )
  
  # Boxplot
  plot <- ggplot(data_prepared, aes(x = treat_status, y = .data[[var]], fill = treat_status, color = treat_status)) +
    geom_boxplot(width = 0.6, outlier.shape = ifelse(remove_outliers, NA, 16), size = 1.2) +
    stat_boxplot(geom = "errorbar", width = 0.3, size = 0.6) +
    geom_segment(data = medians,
                 aes(x = as.numeric(factor(treat_status)) - 0.3,
                     xend = as.numeric(factor(treat_status)) + 0.3,
                     y = med, yend = med),
                 color = "white", size = 1.2, inherit.aes = FALSE) +
    geom_text(data = medians,
              aes(x = treat_status, y = med, label = round(med, 2)),
              vjust = -0.8, size = 4.0, color = "black", fontface = "bold", inherit.aes = FALSE) +
    scale_fill_manual(values = fill_colors) +
    scale_color_manual(values = fill_colors) +
    labs(
      title = final_title,
      x = NULL,
      y = NULL
    ) +
    theme_minimal(base_size = 14) +
    theme(
      legend.position = "none",
      panel.grid.major.x = element_blank(),
      axis.text.x = element_text(size = 12),
      plot.title = element_text(hjust = 0)
    )
  
  # Save
  ggsave(filename = path, plot = plot, width = 6, height = 5)
}


```


```{r}
boxplot_function_2(final_dataset, "average_soya_beans_market_price_usd", plot_title = "SOYA BEANS", remove_outliers = TRUE)

boxplot_function_2(final_dataset, "hulled_average_price_usd", plot_title = "HULLED COFFEE", remove_outliers = TRUE)
```


```{r}

final_dataset %>% select(average_soya_beans_market_price_usd) %>% summarise(Mean = mean(average_soya_beans_market_price_usd, na.rm = TRUE)) %>% View()
```

Food Banana Price

